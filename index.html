<script>
    let conversationHistory = [];

    async function generateContent() {
        const inputText = document.getElementById('inputText').value.trim().toLowerCase(); // Ambil teks input

        if (inputText === "") {
            alert("Pertanyaan tidak boleh kosong.");
            return;
        }

        // API key dipecah menjadi beberapa bagian
        const apiKeyParts = ['AIzaSyCrE7', '1mcvtzBsy', 'LZljkDslmY', 'jQC9VrZCcs'];
        const apiKey = apiKeyParts.join(''); // Menggabungkan bagian-bagian API key

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
        
        const fileInput = document.getElementById('fileInput');
        let fileText = '';

        // Cek apakah ada file yang diunggah
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            
            // Handle PDF files
            if (file.type === "application/pdf") {
                fileText = await readPDF(file);
            }
            // Handle Excel files
            else if (file.type === "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" || file.type === "application/vnd.ms-excel") {
                fileText = await readExcel(file);
            }
            // Handle Word documents
            else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
                const arrayBuffer = await file.arrayBuffer();
                const { value } = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                fileText = value;
            }
            // Handle text files
            else if (file.type === "text/plain") {
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileText = e.target.result;
                };
                reader.readAsText(file);
            }
        }

        // Gabungkan percakapan sebelumnya, teks input, dan file text
        const combinedText = conversationHistory.join(' ') + ' ' + inputText + ' ' + fileText;
        conversationHistory.push(inputText);

        const data = {
            contents: [
                {
                    parts: [
                        { text: combinedText }
                    ]
                }
            ]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error('Network response was not ok.');
            }

            const result = await response.json();
            console.log(result);
            
            if (result && result.candidates && result.candidates.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                document.getElementById('response').innerText = text;
                conversationHistory.push(text);
            } else {
                document.getElementById('response').innerText = "No valid response from the AI.";
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('response').innerText = "Error fetching data.";
        }
    }

    async function readPDF(file) {
        const pdfData = await file.arrayBuffer();
        const pdfDoc = await pdfjsLib.getDocument({data: pdfData}).promise;
        let text = '';

        for (let i = 1; i <= pdfDoc.numPages; i++) {
            const page = await pdfDoc.getPage(i);
            const content = await page.getTextContent();
            const pageText = content.items.map(item => item.str).join(' ');
            text += pageText + ' ';
        }

        return text;
    }

    async function readExcel(file) {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data, { type: 'array' });
        let text = '';

        workbook.SheetNames.forEach(sheetName => {
            const worksheet = workbook.Sheets[sheetName];
            text += XLSX.utils.sheet_to_csv(worksheet) + '\n';
        });

        return text;
    }

    // Fungsi untuk menghapus riwayat percakapan dan membersihkan tampilan
    function clearConversation() {
        conversationHistory = [];
        document.getElementById('inputText').value = '';
        document.getElementById('response').innerText = '';
        document.getElementById('fileInput').value = '';
    }

    document.getElementById('inputText').addEventListener('keypress', function (event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            generateContent();
        }
    });
</script>
